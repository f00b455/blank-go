name: Auto Triage Issues

on:
  issues:
    types: [opened, labeled]

jobs:
  triage:
    # Only run on newly opened issues or when 'triage' label is added
    if: |
      github.event.action == 'opened' ||
      (github.event.action == 'labeled' && github.event.label.name == 'triage')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Auto-triage with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Analyze this newly opened issue and:

            1. **Add appropriate labels** based on the issue content:
               - `bug` for bug reports
               - `enhancement` for new feature requests or improvements
               - `documentation` for docs-related issues
               - `testing` for test-related issues
               - `question` for questions or discussions
               - `ci/cd` for CI/CD related issues
               - `security` for security vulnerabilities or concerns
               - `performance` for performance-related issues
               - `breaking-change` for changes that break backwards compatibility

            2. **Set priority label** based on impact (if applicable):
               - `critical` for security issues or breaking bugs that need immediate attention
               - `high-priority` for important features or significant bugs

            3. **Identify the affected area** and add labels:
               - `frontend` for frontend/UI issues
               - `backend` for backend/API issues
               - `user-story` if the issue describes a user story

            4. **Assess complexity** (if enough information is provided):
               - `good-first-issue` for simple issues suitable for newcomers
               - `complex` for issues requiring significant effort
               - `epic` if this represents a large feature

            5. **Add a welcoming comment** that:
               - Thanks the user for opening the issue
               - Summarizes your understanding of the issue
               - Mentions the labels you've added
               - Asks for any clarification if needed

            Use `gh issue edit` to add labels and `gh issue comment` to add your response.
            Be friendly and professional in your communication.

          claude_args: |
            --allowed-tools "Bash(gh issue edit:*),Bash(gh issue comment:*),Bash(gh issue view:*),Bash(gh label list:*)"