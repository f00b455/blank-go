name: Project Automation

on:
  issues:
    types: [opened, closed, reopened, labeled]
  pull_request:
    types: [opened, closed, ready_for_review, converted_to_draft]

jobs:
  auto-add-to-project:
    name: Auto-add to Project
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Add issue to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/f00b455/projects/3
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}

  update-status-on-pr:
    name: Update Status on PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Get linked issues
        id: get-issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Extract issue numbers from PR body (Fixes #123, Closes #456, etc.)
            const issueNumbers = [];
            const regex = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?\s*#(\d+)/gi;
            let match;
            while ((match = regex.exec(body)) !== null) {
              issueNumbers.push(parseInt(match[1]));
            }

            console.log('Found linked issues:', issueNumbers);
            return issueNumbers;

      - name: Move to In Progress
        if: github.event.action == 'opened' || github.event.action == 'ready_for_review'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const issueNumbers = ${{ steps.get-issues.outputs.result }};
            const projectId = 'PVT_kwHOAA4Ma84BEAb0'; // Project #3
            const fieldId = 'PVTSSF_lAHOAA4Ma84BEAb0zg1wlfI'; // Status field
            const inProgressId = '47fc9ee4'; // "In progress" option

            for (const issueNum of issueNumbers) {
              try {
                // Get issue node ID
                const { data: issue } = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNum
                });

                // Find project item
                const query = `
                  query($projectId: ID!, $contentId: ID!) {
                    node(id: $projectId) {
                      ... on ProjectV2 {
                        items(first: 100) {
                          nodes {
                            id
                            content {
                              ... on Issue {
                                id
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                `;

                const result = await github.graphql(query, {
                  projectId: projectId,
                  contentId: issue.node_id
                });

                const item = result.node.items.nodes.find(
                  n => n.content?.id === issue.node_id
                );

                if (!item) {
                  console.log(`Issue #${issueNum} not in project, skipping`);
                  continue;
                }

                // Update status to In Progress
                const mutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: $projectId
                      itemId: $itemId
                      fieldId: $fieldId
                      value: {singleSelectOptionId: $value}
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;

                await github.graphql(mutation, {
                  projectId: projectId,
                  itemId: item.id,
                  fieldId: fieldId,
                  value: inProgressId
                });

                console.log(`✅ Moved issue #${issueNum} to In Progress`);
              } catch (error) {
                console.error(`Failed to update issue #${issueNum}:`, error.message);
              }
            }

  update-status-on-close:
    name: Update Status on Close
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'closed'
    steps:
      - name: Move to Done
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const issue = context.payload.issue;
            const projectId = 'PVT_kwHOAA4Ma84BEAb0'; // Project #3
            const fieldId = 'PVTSSF_lAHOAA4Ma84BEAb0zg1wlfI'; // Status field
            const doneId = '98236657'; // "Done" option

            try {
              // Find project item
              const query = `
                query($projectId: ID!, $contentId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              id
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const result = await github.graphql(query, {
                projectId: projectId,
                contentId: issue.node_id
              });

              const item = result.node.items.nodes.find(
                n => n.content?.id === issue.node_id
              );

              if (!item) {
                console.log('Issue not in project, skipping');
                return;
              }

              // Update status to Done
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {singleSelectOptionId: $value}
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(mutation, {
                projectId: projectId,
                itemId: item.id,
                fieldId: fieldId,
                value: doneId
              });

              console.log(`✅ Moved issue #${issue.number} to Done`);
            } catch (error) {
              console.error('Failed to update issue:', error.message);
            }

  set-initial-status:
    name: Set Initial Status for New Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Set status to New
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const issue = context.payload.issue;
            const projectId = 'PVT_kwHOAA4Ma84BEAb0'; // Project #3
            const fieldId = 'PVTSSF_lAHOAA4Ma84BEAb0zg1wlfI'; // Status field
            const newId = 'f75ad846'; // "Backlog" option (we use this as default)

            // Wait a bit for auto-add-to-project to complete
            await new Promise(resolve => setTimeout(resolve, 5000));

            try {
              // Find project item
              const query = `
                query($projectId: ID!, $contentId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 100) {
                        nodes {
                          id
                          content {
                            ... on Issue {
                              id
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const result = await github.graphql(query, {
                projectId: projectId,
                contentId: issue.node_id
              });

              const item = result.node.items.nodes.find(
                n => n.content?.id === issue.node_id
              );

              if (!item) {
                console.log('Issue not in project yet, skipping status update');
                return;
              }

              // Update status to Backlog
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: {singleSelectOptionId: $value}
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(mutation, {
                projectId: projectId,
                itemId: item.id,
                fieldId: fieldId,
                value: newId
              });

              console.log(`✅ Set issue #${issue.number} to Backlog`);
            } catch (error) {
              console.error('Failed to set initial status:', error.message);
            }
