#!/bin/bash
# Pre-push hook: Enforce test coverage before pushing
# This prevents pushing code that doesn't meet the coverage threshold

set -e

COVERAGE_THRESHOLD=90.0
COVERAGE_FILE=$(mktemp)

echo "Running tests with coverage check..."
echo "Coverage threshold: ${COVERAGE_THRESHOLD}%"
echo ""

# Run tests and capture coverage (excluding generated mocks)
# Find all packages except mocks directories
PACKAGES=$(go list ./cmd/... ./internal/... ./pkg/... ./features/... 2>/dev/null | grep -v '/mocks$' || true)

if [ -z "$PACKAGES" ]; then
    echo "No packages found to test"
    exit 1
fi

if ! go test -coverprofile="$COVERAGE_FILE" -covermode=atomic $PACKAGES 2>&1; then
    echo ""
    echo "PUSH BLOCKED: Tests failed"
    rm -f "$COVERAGE_FILE"
    exit 1
fi

# Extract coverage percentage
COVERAGE=$(go tool cover -func="$COVERAGE_FILE" | grep total | awk '{print $3}' | sed 's/%//')
rm -f "$COVERAGE_FILE"

if [ -z "$COVERAGE" ]; then
    echo ""
    echo "PUSH BLOCKED: Could not extract coverage"
    exit 1
fi

echo ""
echo "Coverage: ${COVERAGE}%"
echo "Threshold: ${COVERAGE_THRESHOLD}%"

# Compare using bc for floating point
RESULT=$(echo "$COVERAGE >= $COVERAGE_THRESHOLD" | bc -l)

if [ "$RESULT" -eq 1 ]; then
    echo ""
    echo "Coverage check PASSED"
    exit 0
else
    echo ""
    echo "PUSH BLOCKED: Coverage ${COVERAGE}% is below threshold ${COVERAGE_THRESHOLD}%"
    echo ""
    echo "Add more tests before pushing!"
    exit 1
fi
